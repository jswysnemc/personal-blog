import { useState, useEffect, useRef } from 'react';
import Prism from 'prismjs';

// Import common languages
import 'prismjs/components/prism-javascript';
import 'prismjs/components/prism-typescript';
import 'prismjs/components/prism-jsx';
import 'prismjs/components/prism-tsx';
import 'prismjs/components/prism-css';
import 'prismjs/components/prism-python';
import 'prismjs/components/prism-bash';
import 'prismjs/components/prism-json';
import 'prismjs/components/prism-markdown';
import 'prismjs/components/prism-yaml';
import 'prismjs/components/prism-sql';
import 'prismjs/components/prism-go';
import 'prismjs/components/prism-rust';
import 'prismjs/components/prism-java';
import 'prismjs/components/prism-c';
import 'prismjs/components/prism-cpp';
import 'prismjs/components/prism-docker';

interface Props {
  language?: string;
  children: string;
}

// Language aliases
const languageAliases: Record<string, string> = {
  js: 'javascript',
  ts: 'typescript',
  py: 'python',
  sh: 'bash',
  shell: 'bash',
  zsh: 'bash',
  yml: 'yaml',
  md: 'markdown',
  'c++': 'cpp',
  dockerfile: 'docker',
};

// Language icons (SVG paths)
const getLanguageIcon = (lang: string) => {
  const icons: Record<string, { icon: JSX.Element; color: string }> = {
    javascript: {
      icon: <path d="M3 3h18v18H3V3zm16.525 13.707c-.131-.821-.666-1.511-2.252-2.155-.552-.259-1.165-.438-1.349-.854-.068-.248-.078-.382-.034-.529.113-.484.687-.629 1.137-.495.293.09.563.315.732.676.775-.507.775-.507 1.316-.844-.203-.314-.304-.451-.439-.586-.473-.528-1.103-.798-2.126-.775l-.528.067c-.507.124-.991.395-1.283.754-.855.968-.608 2.655.427 3.354 1.023.765 2.521.933 2.712 1.653.18.878-.652 1.159-1.475 1.058-.607-.136-.945-.439-1.316-1.002l-1.372.788c.157.359.337.517.607.832 1.305 1.316 4.568 1.249 5.153-.754.021-.067.18-.528.056-1.237l.006.003zm-6.737-5.434h-1.686c0 1.453-.007 2.898-.007 4.354 0 .924.047 1.772-.104 2.033-.247.517-.886.451-1.175.359-.297-.146-.448-.349-.623-.641-.047-.078-.082-.146-.095-.146l-1.368.844c.229.473.563.879.994 1.137.641.383 1.502.507 2.404.305.588-.17 1.095-.519 1.358-1.059.384-.697.302-1.553.299-2.509.008-1.541 0-3.083 0-4.635l.003-.042z" />,
      color: '#f7df1e'
    },
    typescript: {
      icon: <path d="M3 3h18v18H3V3zm10.71 14.43c.45.23 1.06.39 1.71.39.65 0 1.16-.13 1.54-.39.38-.26.57-.63.57-1.11 0-.35-.1-.64-.31-.87-.21-.23-.58-.43-1.11-.6l-.74-.22c-.25-.08-.43-.16-.54-.25a.38.38 0 01-.17-.33c0-.15.06-.27.19-.36.13-.09.31-.13.54-.13.39 0 .83.13 1.32.39l.55-.95c-.54-.32-1.18-.48-1.91-.48-.59 0-1.07.14-1.44.41-.37.27-.55.65-.55 1.13 0 .67.43 1.16 1.29 1.47l.77.25c.28.09.47.18.58.27.11.09.16.21.16.36 0 .33-.26.49-.77.49-.51 0-1.05-.18-1.62-.55l-.58.99zm-3.21-.12V14.5h1.49v-1.07H8.03v1.07h1.49v2.81h-2.02z" />,
      color: '#3178c6'
    },
    python: {
      icon: <path d="M11.914 0C5.82 0 6.2 2.656 6.2 2.656l.007 2.752h5.814v.826H3.9S0 5.789 0 11.969c0 6.18 3.403 5.96 3.403 5.96h2.03v-2.867s-.109-3.42 3.35-3.42h5.766s3.24.052 3.24-3.148V3.202S18.28 0 11.914 0zM8.708 1.85c.578 0 1.046.47 1.046 1.052 0 .58-.468 1.051-1.046 1.051-.578 0-1.046-.47-1.046-1.051 0-.582.468-1.052 1.046-1.052z" />,
      color: '#3776ab'
    },
    go: {
      icon: <path d="M1.811 10.231c-.047 0-.058-.023-.035-.059l.246-.315c.023-.035.081-.058.128-.058h4.172c.046 0 .058.035.035.07l-.199.303c-.023.036-.082.07-.117.07zM.047 11.306c-.047 0-.059-.023-.035-.058l.245-.316c.023-.035.082-.058.129-.058h5.328c.047 0 .07.035.058.07l-.093.28c-.012.047-.058.07-.105.07zm2.828 1.075c-.047 0-.059-.035-.035-.07l.163-.292c.023-.035.07-.07.117-.07h2.337c.047 0 .07.035.07.082l-.023.28c0 .047-.047.082-.082.082zM12.129 10.02c-.738.187-1.239.327-1.963.514-.176.046-.187.058-.34-.117-.174-.199-.303-.327-.548-.444-.737-.362-1.449-.257-2.115.175-.795.514-1.204 1.274-1.192 2.22.011.935.654 1.706 1.577 1.835.795.105 1.46-.175 1.987-.771.105-.128.198-.269.315-.433H7.786c-.245 0-.304-.152-.222-.35.152-.362.432-.97.596-1.274a.315.315 0 01.292-.187h4.253c-.023.316-.023.631-.07.947a4.983 4.983 0 01-.958 2.29c-.841 1.11-1.94 1.8-3.33 1.986-1.145.152-2.209-.07-3.143-.77-.865-.655-1.356-1.52-1.484-2.595-.152-1.274.222-2.419.936-3.446.77-1.11 1.835-1.87 3.143-2.22 1.11-.292 2.185-.246 3.2.327.771.433 1.286 1.063 1.577 1.882.047.128.012.175-.117.21z" />,
      color: '#00add8'
    },
    rust: {
      icon: <path d="M23.8 14.1l-1.3-.5c0-.2-.1-.3-.1-.5l1.1-.9c.2-.2.3-.5.1-.8l-.6-1c-.1-.2-.4-.4-.7-.3l-1.4.3c-.1-.1-.3-.2-.4-.3l.2-1.4c0-.3-.1-.6-.4-.7l-1.1-.5c-.3-.1-.6 0-.8.2l-.9 1.1c-.2 0-.3 0-.5-.1l-.5-1.3c-.1-.3-.4-.5-.7-.4l-1.2.1c-.3 0-.5.2-.6.5l-.2 1.4c-.2.1-.3.1-.5.2l-1.1-.9c-.2-.2-.5-.3-.8-.1l-1 .6c-.2.2-.4.4-.3.7l.3 1.4c-.1.1-.2.3-.3.4l-1.4-.2c-.3 0-.6.1-.7.4l-.5 1.1c-.1.3 0 .6.2.8l1.1.9c0 .2-.1.3-.1.5l-1.3.5c-.3.1-.4.4-.4.7l.1 1.2c0 .3.2.5.5.6l1.4.2c.1.2.1.3.2.5l-.9 1.1c-.2.2-.2.5-.1.8l.6 1c.2.2.4.4.7.3l1.4-.3c.1.1.3.2.4.3l-.2 1.4c0 .3.1.6.4.7l1.1.5c.3.1.6 0 .8-.2l.9-1.1c.2 0 .3 0 .5.1l.5 1.3c.1.3.4.4.7.4l1.2-.1c.3 0 .5-.2.6-.5l.2-1.4c.2-.1.3-.1.5-.2l1.1.9c.2.2.5.2.8.1l1-.6c.2-.2.4-.4.3-.7l-.3-1.4c.1-.1.2-.3.3-.4l1.4.2c.3 0 .6-.1.7-.4l.5-1.1c.1-.3 0-.6-.2-.8l-1.1-.9c0-.2.1-.3.1-.5l1.3-.5c.3-.1.4-.4.4-.7l-.1-1.2c0-.3-.2-.6-.5-.6zm-11.8 6c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z" />,
      color: '#dea584'
    },
    java: {
      icon: <path d="M8.851 18.56s-.917.534.653.714c1.902.218 2.874.187 4.969-.211 0 0 .552.346 1.321.646-4.699 2.013-10.633-.118-6.943-1.149m-.575-2.627s-1.028.761.542.924c2.032.209 3.636.227 6.413-.308 0 0 .384.389.987.602-5.679 1.661-12.007.13-7.942-1.218m4.84-4.458c1.158 1.333-.304 2.533-.304 2.533s2.939-1.518 1.589-3.418c-1.261-1.772-2.228-2.652 3.007-5.688 0-.001-8.216 2.051-4.292 6.573m6.756 9.826s.679.559-.747.991c-2.712.822-11.288 1.069-13.669.033-.856-.373.75-.89 1.254-.998.527-.114.828-.093.828-.093-.953-.671-6.156 1.317-2.643 1.887 9.58 1.553 17.462-.7 14.977-1.82M9.292 13.21s-4.362 1.036-1.544 1.412c1.189.159 3.561.123 5.77-.062 1.806-.152 3.618-.477 3.618-.477s-.637.272-1.098.587c-4.429 1.165-12.986.623-10.522-.568 2.082-1.006 3.776-.892 3.776-.892m7.824 4.377c4.503-2.34 2.421-4.589.968-4.285-.355.074-.515.138-.515.138s.132-.207.385-.297c2.875-1.011 5.086 2.981-.928 4.562 0-.001.07-.062.09-.118M11.5 0s2.495 2.494-2.366 6.33c-3.896 3.077-.889 4.832 0 6.836-2.274-2.053-3.943-3.858-2.824-5.539 1.644-2.469 6.197-3.665 5.19-7.627" />,
      color: '#007396'
    },
    bash: {
      icon: <path d="M21.038 4.9l-7.577-4.498C13.009.134 12.505 0 12 0c-.505 0-1.009.134-1.462.403L2.961 4.9C2.057 5.437 1.5 6.429 1.5 7.5v8.998c0 1.072.557 2.064 1.461 2.6l7.577 4.5c.454.27.958.402 1.462.402.505 0 1.009-.132 1.462-.402l7.577-4.5c.904-.536 1.461-1.528 1.461-2.6V7.5c0-1.071-.557-2.063-1.462-2.6zM15.17 18.22l-1.016.587c-.09.053-.153.037-.19-.046-.038-.084-.012-.157.077-.22l.99-.58c.127-.09.22-.027.22.106v.153zm.527-5.124c-.197.09-.37.027-.52-.143-.113-.127-.19-.297-.233-.51v-.05c0-.03.017-.053.05-.067.197-.09.37-.027.52.143.113.127.19.297.233.51v.05c0 .027-.017.05-.05.067zm-.747-1.7c0 .387-.27.527-.6.32l-3.4-1.96c-.33-.19-.6-.657-.6-1.044V5.845c0-.387.27-.527.6-.32l3.4 1.96c.33.19.6.657.6 1.044v2.867zm4.603 2.997l-2.697 1.56c-.1.06-.183.01-.183-.11v-.44c0-.12.083-.26.183-.32l2.697-1.56c.1-.06.183-.01.183.11v.44c0 .12-.083.26-.183.32z" />,
      color: '#4eaa25'
    },
    json: {
      icon: <path d="M12.043 23.968c.479-.004.953-.029 1.426-.094a11.805 11.805 0 003.146-.863 12.404 12.404 0 003.793-2.542 11.977 11.977 0 002.44-3.427 11.794 11.794 0 001.02-3.476c.149-1.16.135-2.346-.045-3.499a11.96 11.96 0 00-.793-2.788 11.197 11.197 0 00-.854-1.617c-1.168-1.837-2.861-3.314-4.81-4.303a12.835 12.835 0 00-2.172-.87h-.005c.119.063.24.132.345.201.553.365 1.033.805 1.479 1.278a7.159 7.159 0 011.62 2.99 7.94 7.94 0 01-.068 4.131c-.346 1.152-.851 2.245-1.479 3.259-.418.676-.868 1.331-1.389 1.927a5.2 5.2 0 00-.172-.4c-.239-.5-.586-.929-.992-1.297a4.482 4.482 0 00-1.648-.912c-.542-.171-1.099-.223-1.661-.166-.759.078-1.476.365-2.075.825-.601.461-1.081 1.07-1.396 1.758a5.097 5.097 0 00-.411 1.959c0 .766.196 1.52.569 2.19.346.62.835 1.148 1.427 1.549.586.397 1.254.661 1.954.778.787.132 1.595.085 2.362-.131a4.976 4.976 0 002.035-1.174c-.056.034-.115.064-.171.095-.869.476-1.867.764-2.883.819a7.025 7.025 0 01-2.922-.471c-.886-.349-1.678-.903-2.3-1.614-.438-.501-.793-1.071-1.05-1.688-.257-.615-.412-1.272-.462-1.937a6.873 6.873 0 01.137-1.82c.127-.6.334-1.177.614-1.72a6.9 6.9 0 011.312-1.75c.543-.505 1.169-.913 1.853-1.202a7.084 7.084 0 012.299-.509 6.906 6.906 0 012.318.234c-.006-.005-.012-.009-.019-.013-.859-.416-1.778-.688-2.72-.835a11.382 11.382 0 00-2.956-.101 11.94 11.94 0 00-2.883.627 12.057 12.057 0 00-3.991 2.286A11.99 11.99 0 001.16 9.18a12.133 12.133 0 00-.866 3.168 12.032 12.032 0 00.115 3.508c.189 1.084.537 2.125 1.029 3.094a11.96 11.96 0 002.254 3.041 11.997 11.997 0 003.145 2.27c1.013.496 2.098.845 3.218 1.024a12.41 12.41 0 001.988.138z" />,
      color: '#000000'
    },
    css: {
      icon: <path d="M1.5 0h21l-1.91 21.563L11.977 24l-8.565-2.438L1.5 0zm17.09 4.413L5.41 4.41l.213 2.622 10.125.002-.255 2.716h-6.64l.24 2.573h6.182l-.366 3.523-2.91.804-2.956-.81-.188-2.11h-2.61l.29 3.855L12 19.288l5.373-1.53L18.59 4.414z" />,
      color: '#1572b6'
    },
    html: {
      icon: <path d="M1.5 0h21l-1.91 21.563L11.977 24l-8.565-2.438L1.5 0zm7.031 9.75l-.232-2.718 10.059.003.23-2.622L5.412 4.41l.698 8.01h9.126l-.326 3.426-2.91.804-2.955-.81-.188-2.11H6.248l.33 4.171L12 19.351l5.379-1.443.744-8.157H8.531z" />,
      color: '#e34f26'
    },
    docker: {
      icon: <path d="M13.983 11.078h2.119a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.119a.185.185 0 00-.185.185v1.888c0 .102.083.185.185.185m-2.954-5.43h2.118a.186.186 0 00.186-.186V3.574a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.186m0 2.716h2.118a.187.187 0 00.186-.186V6.29a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.887c0 .102.082.185.185.186m-2.93 0h2.12a.186.186 0 00.184-.186V6.29a.185.185 0 00-.185-.185H8.1a.185.185 0 00-.185.185v1.887c0 .102.083.185.185.186m-2.964 0h2.119a.186.186 0 00.185-.186V6.29a.185.185 0 00-.185-.185H5.136a.186.186 0 00-.186.185v1.887c0 .102.084.185.186.186m5.893 2.715h2.118a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.185m-2.93 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.083.185.185.185m-2.964 0h2.119a.185.185 0 00.185-.185V9.006a.185.185 0 00-.184-.186h-2.12a.186.186 0 00-.186.186v1.887c0 .102.084.185.186.185m-2.92 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.082.185.185.185M23.763 9.89c-.065-.051-.672-.51-1.954-.51-.338.001-.676.03-1.01.087-.248-1.7-1.653-2.53-1.716-2.566l-.344-.199-.226.327c-.284.438-.49.922-.612 1.43-.23.97-.09 1.882.403 2.661-.595.332-1.55.413-1.744.42H.751a.751.751 0 00-.75.748 11.376 11.376 0 00.692 4.062c.545 1.428 1.355 2.48 2.41 3.124 1.18.723 3.1 1.137 5.275 1.137.983.003 1.963-.086 2.93-.266a12.248 12.248 0 003.823-1.389c.98-.567 1.86-1.288 2.61-2.136 1.252-1.418 1.998-2.997 2.553-4.4h.221c1.372 0 2.215-.549 2.68-1.009.309-.293.55-.65.707-1.046l.098-.288z" />,
      color: '#2496ed'
    },
    sql: {
      icon: <path d="M12 3C7.58 3 4 4.79 4 7v10c0 2.21 3.59 4 8 4s8-1.79 8-4V7c0-2.21-3.58-4-8-4zm0 2c3.87 0 6 1.5 6 2s-2.13 2-6 2-6-1.5-6-2 2.13-2 6-2zm6 12c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23c1.61.78 3.72 1.23 6 1.23s4.39-.45 6-1.23V17zm0-4c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23c1.61.78 3.72 1.23 6 1.23s4.39-.45 6-1.23V13zm0-4c0 .5-2.13 2-6 2s-6-1.5-6-2V6.77C7.61 7.55 9.72 8 12 8s4.39-.45 6-1.23V9z" />,
      color: '#00618a'
    },
    yaml: {
      icon: <path d="M.2 5.2l5.4 6.9v6.7h2.8v-6.7l5.4-6.9H10L6.9 9.6 3.8 5.2H.2zm17.6 0v13.6h5.3c2.2 0 3.3-1.1 3.3-3.3v-7c0-2.2-1.1-3.3-3.3-3.3h-5.3zm2.9 2.7h2.4v8.2h-2.4V7.9z" />,
      color: '#cb171e'
    },
    markdown: {
      icon: <path d="M22.27 19.385H1.73A1.73 1.73 0 010 17.655V6.345a1.73 1.73 0 011.73-1.73h20.54A1.73 1.73 0 0124 6.345v11.308a1.73 1.73 0 01-1.73 1.731zM5.769 15.923v-4.5l2.308 2.885 2.307-2.885v4.5h2.308V8.078h-2.308l-2.307 2.885-2.308-2.885H3.46v7.847zM21.232 12h-2.309V8.077h-2.307V12h-2.308l3.462 4.615z" />,
      color: '#083fa1'
    },
    c: {
      icon: <path d="M16.5 10c-.5-1.5-1.8-3-4.5-3-3.3 0-5 2.5-5 5s1.7 5 5 5c2.7 0 4-1.5 4.5-3h3c-.6 3.4-3.4 6-7.5 6-5 0-8-3.6-8-8s3-8 8-8c4.1 0 6.9 2.6 7.5 6h-3z" />,
      color: '#a8b9cc'
    },
    cpp: {
      icon: <path d="M22.394 6c-.167-.29-.398-.543-.652-.69L12.926.22c-.509-.294-1.34-.294-1.848 0L2.26 5.31c-.508.293-.923 1.013-.923 1.6v10.18c0 .294.104.62.271.91.167.29.398.543.652.69l8.816 5.09c.508.293 1.34.293 1.848 0l8.816-5.09c.254-.147.485-.4.652-.69.167-.29.27-.616.27-.91V6.91c.003-.294-.1-.62-.268-.91zM12 19.11c-3.92 0-7.109-3.19-7.109-7.11 0-3.92 3.19-7.11 7.11-7.11a7.133 7.133 0 016.156 3.553l-3.076 1.78a3.567 3.567 0 00-3.08-1.78A3.56 3.56 0 008.444 12 3.56 3.56 0 0012 15.555a3.57 3.57 0 003.08-1.778l3.078 1.78A7.135 7.135 0 0112 19.11zm7.11-6.715h-.79v.79h-.79v-.79h-.79v-.79h.79v-.79h.79v.79h.79zm2.962 0h-.79v.79h-.79v-.79h-.79v-.79h.79v-.79h.79v.79h.79z" />,
      color: '#00599c'
    },
    jsx: {
      icon: <path d="M12 9.861A2.139 2.139 0 1 0 12 14.139 2.139 2.139 0 1 0 12 9.861zM6.008 16.255l-.472-.12C2.018 15.246 0 13.737 0 11.996s2.018-3.25 5.536-4.139l.472-.119.133.468a23.53 23.53 0 0 0 1.363 3.578l.101.213-.101.213a23.307 23.307 0 0 0-1.363 3.578l-.133.467zM5.317 8.95c-2.674.751-4.315 1.9-4.315 3.046 0 1.145 1.641 2.294 4.315 3.046a24.95 24.95 0 0 1 1.182-3.046A24.752 24.752 0 0 1 5.317 8.95zM17.992 16.255l-.133-.469a23.357 23.357 0 0 0-1.364-3.577l-.101-.213.101-.213a23.42 23.42 0 0 0 1.364-3.578l.133-.468.473.119c3.517.889 5.535 2.398 5.535 4.14s-2.018 3.25-5.535 4.139l-.473.12zm-.491-4.259a24.726 24.726 0 0 1 1.182 3.046c2.675-.752 4.315-1.901 4.315-3.046 0-1.146-1.641-2.294-4.315-3.046a24.855 24.855 0 0 1-1.182 3.046z" />,
      color: '#61dafb'
    },
    tsx: {
      icon: <path d="M12 9.861A2.139 2.139 0 1 0 12 14.139 2.139 2.139 0 1 0 12 9.861zM6.008 16.255l-.472-.12C2.018 15.246 0 13.737 0 11.996s2.018-3.25 5.536-4.139l.472-.119.133.468a23.53 23.53 0 0 0 1.363 3.578l.101.213-.101.213a23.307 23.307 0 0 0-1.363 3.578l-.133.467zM5.317 8.95c-2.674.751-4.315 1.9-4.315 3.046 0 1.145 1.641 2.294 4.315 3.046a24.95 24.95 0 0 1 1.182-3.046A24.752 24.752 0 0 1 5.317 8.95zM17.992 16.255l-.133-.469a23.357 23.357 0 0 0-1.364-3.577l-.101-.213.101-.213a23.42 23.42 0 0 0 1.364-3.578l.133-.468.473.119c3.517.889 5.535 2.398 5.535 4.14s-2.018 3.25-5.535 4.139l-.473.12zm-.491-4.259a24.726 24.726 0 0 1 1.182 3.046c2.675-.752 4.315-1.901 4.315-3.046 0-1.146-1.641-2.294-4.315-3.046a24.855 24.855 0 0 1-1.182 3.046z" />,
      color: '#3178c6'
    },
  };

  const langConfig = icons[lang];
  if (!langConfig) return null;

  return (
    <svg
      className="w-4 h-4"
      viewBox="0 0 24 24"
      fill={langConfig.color}
    >
      {langConfig.icon}
    </svg>
  );
};

export default function CodeBlock({ language, children }: Props) {
  const [copied, setCopied] = useState(false);
  const codeRef = useRef<HTMLElement>(null);

  const normalizedLang = language ? (languageAliases[language.toLowerCase()] || language.toLowerCase()) : 'plaintext';

  useEffect(() => {
    if (codeRef.current && normalizedLang !== 'plaintext') {
      Prism.highlightElement(codeRef.current);
    }
  }, [children, normalizedLang]);

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(children);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  const lines = children.split('\n');
  const showLineNumbers = lines.length > 1;
  const lineNumberWidth = String(lines.length).length;

  return (
    <div className="code-block group relative my-6 rounded-xl overflow-hidden shadow-sm">
      {/* Border gradient - Light/Dark */}
      <div className="absolute inset-0 rounded-xl bg-gradient-to-br from-slate-200 via-slate-300 to-slate-200 dark:from-slate-700 dark:via-slate-600 dark:to-slate-700 p-px">
        <div className="h-full w-full rounded-xl bg-[#fafbfc] dark:bg-[#161b22]" />
      </div>

      {/* Content container */}
      <div className="relative">
        {/* Header bar */}
        <div className="flex items-center justify-between px-3 py-2 bg-gradient-to-r from-slate-100 via-slate-50 to-slate-100 dark:from-[#21262d] dark:via-[#282e38] dark:to-[#21262d] border-b border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3">
            {/* Terminal dots */}
            <div className="flex gap-1.5">
              <div className="w-2.5 h-2.5 rounded-full bg-[#ff5f56] shadow-sm shadow-red-500/20" />
              <div className="w-2.5 h-2.5 rounded-full bg-[#ffbd2e] shadow-sm shadow-yellow-500/20" />
              <div className="w-2.5 h-2.5 rounded-full bg-[#27ca40] shadow-sm shadow-green-500/20" />
            </div>

            {/* Separator */}
            <div className="h-4 w-px bg-slate-300 dark:bg-slate-600" />

            {/* Language icon + badge */}
            <div className="flex items-center gap-1.5">
              {getLanguageIcon(normalizedLang)}
              <span className="text-xs font-medium text-slate-600 dark:text-slate-300 font-mono">
                {language || 'plaintext'}
              </span>
            </div>
          </div>

          <div className="flex items-center gap-3">
            {/* Line count */}
            <span className="text-[10px] text-slate-400 dark:text-slate-500 font-mono">
              {lines.length} {lines.length === 1 ? 'line' : 'lines'}
            </span>

            {/* Copy button */}
            <button
              onClick={handleCopy}
              className={`flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-md transition-all duration-200 border focus:outline-none focus:ring-2 focus:ring-blue-500/30 ${
                copied
                  ? 'text-white bg-green-500 border-green-400'
                  : 'text-slate-500 dark:text-slate-400 hover:text-white hover:bg-blue-500 dark:hover:bg-blue-600 border-transparent hover:border-blue-400'
              }`}
              title="Copy code"
            >
            {copied ? (
              <>
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Copied!</span>
              </>
            ) : (
              <>
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <span>Copy</span>
              </>
            )}
          </button>
          </div>
        </div>

        {/* Code content */}
        <div className="overflow-x-auto">
          <pre
            className="p-4 text-[13px] leading-6 m-0 bg-[#fafbfc] dark:bg-[#161b22]"
            style={{
              fontFamily: '"JetBrains Mono", "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',
              tabSize: 2,
            }}
          >
            {showLineNumbers ? (
              <div className="table w-full">
                {lines.map((line, i) => (
                  <div key={i} className="table-row group/line">
                    <span
                      className="table-cell pr-4 text-right text-slate-400 dark:text-slate-600 select-none
                                 border-r border-slate-200 dark:border-slate-700
                                 group-hover/line:text-slate-500 dark:group-hover/line:text-slate-500 transition-colors"
                      style={{
                        width: `${lineNumberWidth + 1}ch`,
                        minWidth: '2.5rem',
                        userSelect: 'none',
                      }}
                    >
                      {i + 1}
                    </span>
                    <code
                      ref={i === 0 ? codeRef : undefined}
                      className={`table-cell pl-4 group-hover/line:bg-blue-50/50 dark:group-hover/line:bg-blue-900/20 transition-colors language-${normalizedLang}`}
                      style={{ whiteSpace: 'pre' }}
                      dangerouslySetInnerHTML={{
                        __html: normalizedLang !== 'plaintext' && Prism.languages[normalizedLang]
                          ? Prism.highlight(line || ' ', Prism.languages[normalizedLang], normalizedLang)
                          : escapeHtml(line || ' ')
                      }}
                    />
                  </div>
                ))}
              </div>
            ) : (
              <code
                ref={codeRef}
                className={`language-${normalizedLang}`}
                style={{ whiteSpace: 'pre' }}
                dangerouslySetInnerHTML={{
                  __html: normalizedLang !== 'plaintext' && Prism.languages[normalizedLang]
                    ? Prism.highlight(children, Prism.languages[normalizedLang], normalizedLang)
                    : escapeHtml(children)
                }}
              />
            )}
          </pre>
        </div>
      </div>
    </div>
  );
}

function escapeHtml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
